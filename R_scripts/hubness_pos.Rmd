---
title: "Hubness comparison for Lp norms"
output:
  pdf_document: default
  html_document: default
---

```{r libs, results="hide"}
library(ggplot2, quietly = T)
library(viridis, quietly = T)
library(ggpubr, quietly = T)
library(Seurat, quietly = T)
```

Method 2 : mu + 3sigma
Method 3 : 2k
Method 5 : mu + 3sigma_left
Method 6 : anti hubs
Method 7 : MAD

```{r functions}
get_hub2 <- function(df,kval,dimval,pval) { # Using the mean + 3*sd from Tomasev
   x_thd = c()
   hub_nb = c()
   ymin = c()
   ymax = c()
   y_increment = 1
   for (d in dimval) {
      for (k in kval) {
         for (p in pval) {
            val = df$Hubness_score[df$Dimension==d & df$p==p & df$k==k]
            x_thd = c(x_thd, mean(val)+3*sd(val))
            hub_nb = c(hub_nb, sum(val>=(mean(val)+3*sd(val))))
            ymin = c(ymin,y_increment)
            ymax = c(ymax,y_increment+1)
         }
      }
     y_increment <- y_increment+1
   }
   hub_val <- data.frame("p"=rep(pval,times=length(dimval)*length(kval)),
                         "k"=rep(rep(kval,each=length(pval)),times=length(dimval)),
                         "Dimension"=rep(dimval,each=length(kval)*length(pval)),
                         "GHubness"=hub_nb,
                         "Threshold"=x_thd,
                         "ymin"=ymin,
                         "ymax"=ymax)
   return(hub_val)
}
get_hub3 <- function(df,kval,dimval,pval,log=F) { # Using the method from [1] >= 2k
   if (log==T) {
      hub_nb = c()
      ymin = c()
      ymax = c()
      y_increment = 1
      for (d in dimval) {
         for (k in kval) {
            for (p in pval) {
               val = df$Hubness_score[df$Dimension==d & df$p==p & df$k==k]
               hub_nb = c(hub_nb, sum(val>=2*log(k)))
               ymin = c(ymin,y_increment)
               ymax = c(ymax,y_increment+1)
            }
         }
      y_increment <- y_increment+1
      }
   }
   else {
      hub_nb = c()
      ymin = c()
      ymax = c()
      y_increment = 1
      for (d in dimval) {
         for (k in kval) {
            for (p in pval) {
               val = df$Hubness_score[df$Dimension==d & df$p==p & df$k==k]
               hub_nb = c(hub_nb, sum(val>=2*k))
               ymin = c(ymin,y_increment)
               ymax = c(ymax,y_increment+1)
            }
         }
      y_increment <- y_increment+1
      }
   }
   hub_val <- data.frame("p"=rep(pval,times=length(dimval)*length(kval)),
                         "k"=rep(rep(kval,each=length(pval)),times=length(dimval)),
                         "Dimension"=rep(dimval,each=length(kval)*length(pval)),
                         "GHubness"=hub_nb,
                         "ymin"=ymin,
                         "ymax"=ymax)
   hub_val$Threshold <- 2*hub_val$k
   return(hub_val)
}
get_hub5 <- function(df,kval,dimval,pval) { # mu + 3 sigma_left
   x_thd = c()
   hub_nb = c()
   ymin = c()
   ymax = c()
   y_increment = 1
   for (d in dimval) {
      for (k in kval) {
         for (p in pval) {
            val = df$Hubness_score[df$Dimension==d & df$p==p & df$k==k]
            mu = mean(val)
            left_val = val[val<=mu]
            mirror_val = c(left_val,2*mu-left_val)
            left_sigma = sd(mirror_val)
            x_thd = c(x_thd,mu+3*left_sigma)
            hub_nb = c(hub_nb, sum(val>=(mu+3*left_sigma)))
            ymin = c(ymin,y_increment)
            ymax = c(ymax,y_increment+1)
         }
      }
     y_increment <- y_increment+1
   }
   hub_val <- data.frame("p"=rep(pval,times=length(dimval)*length(kval)),
                         "k"=rep(rep(kval,each=length(pval)),times=length(dimval)),
                         "Dimension"=rep(dimval,each=length(kval)*length(pval)),
                         "GHubness"=hub_nb,
                         "Threshold"=x_thd,
                         "ymin"=ymin,
                         "ymax"=ymax)
   return(hub_val)
}
get_hub6 <- function(df,kval,dimval,pval) { # anti hubs
   anti_hub = c()
   for (d in dimval) {
      for (k in kval) {
         for (p in pval) {
           anti_hub = c(anti_hub,unique(df$Antihubs[df$Dimension==d & df$p==p & df$k==k]))
         }
      }
   }
   hub_val <- data.frame("p"=rep(pval,times=length(dimval)*length(kval)),
                         "k"=rep(rep(kval,each=length(pval)),times=length(dimval)),
                         "Dimension"=rep(dimval,each=length(kval)*length(pval)),
                         "GHubness"=anti_hub)
   hub_val$Dimension <- factor(hub_val$Dimension, levels = dimval)
   return(hub_val)
}
get_hub7 <- function(df,kval,dimval,pval) { # median + 3MAD
   x_thd = c()
   hub_nb = c()
   ymin = c()
   ymax = c()
   y_increment = 1
   for (d in dimval) {
      for (k in kval) {
         for (p in pval) {
           val = df$Hubness_score[df$Dimension==d & df$p==p & df$k==k]
           x_thd = c(x_thd, median(val)+3*mad(val,
                                              #center=ifelse(median(val)!=0,median(val),1)
                                              ))
           hub_nb = c(hub_nb, sum(val>=(median(val)+3*mad(val,
                                                          #center=ifelse(median(val)!=0,median(val),1)
                                                          ))))
           ymin = c(ymin,y_increment)
           ymax = c(ymax,y_increment+1)
         }
      }
     y_increment <- y_increment+1
   }
   hub_val <- data.frame("p"=rep(pval,times=length(dimval)*length(kval)),
                         "k"=rep(rep(kval,each=length(pval)),times=length(dimval)),
                         "Dimension"=rep(dimval,each=length(kval)*length(pval)),
                         "GHubness"=hub_nb,
                         "Threshold"=x_thd,
                         "ymin"=ymin,
                         "ymax"=ymax)
   return(hub_val)
}
plot_hub <- function(seurat,hubs,red) {
   DimPlot(guo_seurat, reduction = red, cells.highlight = hubs)
}
```

```{r load data}
source(file="/Users/elise/Desktop/GitHub/Hubness_sc/R_scripts/hubness_load_write_data_guo.R")
guo_data <- read.table("/Users/elise/Desktop/TheÌ€se/scRNAseq/Data_sc/Guo_lung_2018/GSE99254_NSCLC.TCell.S9055.count.labeled.txt")
```

```{r get the hubs with the different methods}
parameter <- data.frame(50,100,"1")
names(parameter) <- c("k","d","p")
val <- hubness$Hubness_score[hubness$k==parameter$k & hubness$Dimension==parameter$d & hubness$p==parameter$p]
thd2 <- get_hub2(hubness,kval=parameter$k,dimval=parameter$d,pval=parameter$p)$Threshold
hub2 <- colnames(guo_data)[val>=thd2]
thd3 <- get_hub3(hubness,kval=parameter$k,dimval=parameter$d,pval=parameter$p)$Threshold
hub3 <- colnames(guo_data)[val>=thd3]
thd5 <- get_hub5(hubness,kval=parameter$k,dimval=parameter$d,pval=parameter$p)$Threshold
hub5 <- colnames(guo_data)[val>=thd5]
hub6 <- colnames(guo_data)[val==0]
thd7 <- get_hub7(hubness,kval=parameter$k,dimval=parameter$d,pval=parameter$p)$Threshold
hub7 <- colnames(guo_data)[val>=thd7]
```

```{r position in various spaces}
guo_seurat <- CreateSeuratObject(guo_data)
guo_seurat[["percent.mt"]] <- PercentageFeatureSet(guo_seurat, pattern = "^MT-")
VlnPlot(guo_seurat, features = c("nFeature_RNA","nCount_RNA","percent.mt"))
FeatureScatter(guo_seurat, feature1 = "nFeature_RNA", feature2 = "nCount_RNA")
# Remove cells with more than 7500 genes or 5e+06 total counts
guo_seurat <- subset(guo_seurat, subset = nFeature_RNA<7500 & nCount_RNA<5e+06) # 9048 cells
VlnPlot(guo_seurat, features = c("nFeature_RNA","nCount_RNA","percent.mt"))
# Normalize + log transfo + scale
guo_seurat <- NormalizeData(guo_seurat)
guo_seurat <- ScaleData(guo_seurat)
guo_seurat <- RunPCA(guo_seurat, features = rownames(guo_seurat))
guo_seurat <- RunUMAP(guo_seurat, dims = 1:50)
guo_seurat <- RunTSNE(guo_seurat, dims = 1:50)
DimPlot(guo_seurat, reduction = "pca")
DimPlot(guo_seurat, reduction = "umap")
DimPlot(guo_seurat, reduction = "tsne")
plot_hub(guo_seurat,red="pca",hubs=hub2)
plot_hub(guo_seurat,red="pca",hubs=hub3)
plot_hub(guo_seurat,red="pca",hubs=hub5)
plot_hub(guo_seurat,red="pca",hubs=hub7)
plot_hub(guo_seurat,red="pca",hubs=hub6)
plot_hub(guo_seurat,red="umap",hubs=hub2)
plot_hub(guo_seurat,red="umap",hubs=hub3)
plot_hub(guo_seurat,red="umap",hubs=hub5)
plot_hub(guo_seurat,red="umap",hubs=hub7)
plot_hub(guo_seurat,red="umap",hubs=hub6)
plot_hub(guo_seurat,red="tsne",hubs=hub2)
plot_hub(guo_seurat,red="tsne",hubs=hub3)
plot_hub(guo_seurat,red="tsne",hubs=hub5)
plot_hub(guo_seurat,red="tsne",hubs=hub7)
plot_hub(guo_seurat,red="tsne",hubs=hub6)
```

